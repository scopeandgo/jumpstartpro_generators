#!/usr/bin/env bash

set -e

github_org="yourorg"
git_repo="https://github.com/jumpstart-pro/jumpstart-pro-rails.git"
git_branch=
force=false

# USAGE: bin/newrepo <repo-name> [-r <git-repo>] [-b <git-branch>] [-o <github-org>] [-l <local-generator-path>] [--force]
while [[ "$#" -gt 0 ]]; do
  case $1 in
  -r | --repo)
    git_repo="$2"
    shift
    ;;
  -b | --branch)
    git_branch="$2"
    shift
    ;;
  -o | --github-org)
    github_org="$2"
    shift
    ;;
  -l | --local-generator-path)
    local_generator_path="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
    ;;
  --force)
    force=true
    ;;
  *) repo_name="$1" ;;
  esac
  shift
done

# show usage if no repo name
if [ -z "$repo_name" ]; then
  echo "Usage: $0 <repo-name> [-r <git-repo>] [-b <git-branch>] [-o <github-org>] [--force]"
  exit 1
fi

# Usage instructions from README
echo "This script initializes a new repository named '$repo_name'."

# if $repo_name exists and $force is not set, exit
if [ -d "$repo_name" ] && [ "$force" = false ]; then
  echo "Repository '$repo_name' already exists. Use --force to overwrite."
  exit 1
fi

# if it exists and $force is set, rm -rf it
if [ -d "$repo_name" ] && [ "$force" = true ]; then
  rm -rf "$repo_name"
fi

function _git() {
  echo git "$@"
  command git "$@"
}

# Clone the repository
if [ -n "$git_branch" ]; then
  _git clone "$git_repo" -o jumpstartpro "$repo_name"
else
  _git clone "$git_repo" -o jumpstartpro "$repo_name"
fi

# Change directory to the new repo
cd "$repo_name" || exit

# app_name = current directory name
app_name=$(basename "$(pwd)")

bundle update

# Install and run the generator
if [ -n "$local_generator_path" ]; then
  bundle add jumpstartpro_generators --path "$local_generator_path"
else
  bundle add jumpstartpro_generators --github scopeandgo/jumpstartpro_generators
fi
bin/rails generate jumpstartpro_generators:install
bundle remove jumpstartpro_generators || true

# Setup the environment
bin/setup

# Re-migrate to update the Solid X schema files
bin/rails db:migrate

# Run the tests
bin/rails test

# Setup local git hooks
overcommit --install

# Fix any Rubocop offenses after generators etc
rubocop -f simple -x || true

echo "Repository '$repo_name' has been initialized successfully."

_git add .
_git commit -m "Installing extras on top of Jumpstart Pro"

echo "To run the app, run:

  cd $repo_name
  direnv allow
  bin/dev

To create new repo on github, run:

  cd $repo_name
  gh repo create $github_org/$app_name --source=. --remote=upstream --private --push
  gh repo set-default $github_org/$app_name

To deploy, create credentials files:

  bin/rails credentials:edit --environment production
  git add .
  git commit -m 'Add initial credentials for production'

To deploy to Hatchbox, visit:

  https://app.hatchbox.io/apps/new

To deploy with Kamal, run:

  # edit config/deploy.yml as necessary
  kamal setup
"
